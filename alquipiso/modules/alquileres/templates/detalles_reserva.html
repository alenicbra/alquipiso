{% extends 'base.html' %}

{% block title %}
    <title>Detalles de la Reserva</title>
{% endblock %}

{% block content %}
<div class="container mt-5">
    <h2>Detalles de la Reserva</h2>

    <p><strong>Alojamiento:</strong> {{ reserva.alojamiento.nombre }}</p>
    <p><strong>Fecha de entrada:</strong> {{ reserva.fecha_entrada }}</p>
    <p><strong>Fecha de salida:</strong> {{ reserva.fecha_salida }}</p>
    <p><strong>Precio Total:</strong> {{ reserva.precio_total }} €</p>

    <button id="checkout-button" class="btn btn-primary">Pagar con Stripe</button>
</div>

<script src="https://js.stripe.com/v3/"></script>
<script>
    const stripe = Stripe("{{ stripe_public_key }}");
    const checkoutButton = document.getElementById('checkout-button');

    checkoutButton.addEventListener('click', function () {
        // Obtener la URL del endpoint de pago
        const url = "{% url 'alquileres:procesar_pago' reserva.id %}";

        // Hacer una solicitud POST para procesar el pago
        fetch(url, {
            method: 'POST',  // Asegurarse de que el método sea POST
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'  // Incluir el token CSRF en el encabezado
            },
            body: JSON.stringify({})  // Enviar cuerpo vacío, pero puedes incluir datos adicionales si lo necesitas
        })
        .then(response => response.json())
        .then(data => {
            if (data.url) {
                // Redirigir a Stripe usando la URL proporcionada en la respuesta del backend
                window.location.href = data.url;
            } else {
                alert('Error al iniciar el proceso de pago');
            }
        })
        .catch(error => {
            alert('Error en la solicitud de pago: ' + error.message);
        });
    });
</script>
{% endblock %}

